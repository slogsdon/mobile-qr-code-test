<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Test</title>

    <script type="text/javascript" src="grid.js"></script>
    <script type="text/javascript" src="version.js"></script>
    <script type="text/javascript" src="detector.js"></script>
    <script type="text/javascript" src="formatinf.js"></script>
    <script type="text/javascript" src="errorlevel.js"></script>
    <script type="text/javascript" src="bitmat.js"></script>
    <script type="text/javascript" src="datablock.js"></script>
    <script type="text/javascript" src="bmparser.js"></script>
    <script type="text/javascript" src="datamask.js"></script>
    <script type="text/javascript" src="rsdecoder.js"></script>
    <script type="text/javascript" src="gf256poly.js"></script>
    <script type="text/javascript" src="gf256.js"></script>
    <script type="text/javascript" src="decoder.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <script type="text/javascript" src="findpat.js"></script>
    <script type="text/javascript" src="alignpat.js"></script>
    <script type="text/javascript" src="databr.js"></script>
    <script type="text/javascript" src="https://hps.github.io/token/2.1/securesubmit.js"></script>

    <script type="text/javascript">
        (function (window, document, undefined) {
            var gCtx = null;
            var gCanvas = null;

            window.handleFiles = function handleFiles(f) {
                var o = [];

                for (var i = 0; i < f.length; i++) {
                    var reader = new FileReader();
                    reader.onload = (function (theFile) {
                        return function (e) {
                            gCtx.clearRect(0, 0, gCanvas.width, gCanvas.height);

                            qrcode.decode(e.target.result);
                        };
                    })(f[i]);
                    reader.readAsDataURL(f[i]);
                }
            };

            function initCanvas(w, h) {
                gCanvas = document.getElementById("qr-canvas");
                gCanvas.style.width = w + "px";
                gCanvas.style.height = h + "px";
                gCanvas.width = w;
                gCanvas.height = h;
                gCtx = gCanvas.getContext("2d");
                gCtx.clearRect(0, 0, w, h);
            }

            function htmlEntities(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            function read(a) {
                var html = "<br>";
                html += "<b>" + htmlEntities(a) + "</b><br><br>";
                document.getElementById("result").innerHTML = html;
                document.getElementById('payment_form').style.display = 'block';
                // Create a new `HPS` object with the necessary configuration
                var hps = new Heartland.HPS({
                    publicKey: 'pkapi_cert_jKc1FtuyAydZhZfbB3',
                    type:      'iframe',
                    // Configure the iframe fields to tell the library where
                    // the iframe should be inserted into the DOM and some
                    // basic options
                    fields: {
                        cardNumber: {
                            target:      'iframesCardNumber',
                            placeholder: '•••• •••• •••• ••••'
                        },
                        cardExpiration: {
                            target:      'iframesCardExpiration',
                            placeholder: 'MM / YYYY'
                        },
                        cardCvv: {
                            target:      'iframesCardCvv',
                            placeholder: 'CVV'
                        },
                        submit: {
                            target:       'iframesSubmit'
                        }
                    },
                    // Collection of CSS to inject into the iframes.
                    // These properties can match the site's styles
                    // to create a seamless experience.
                    style: {
                        'input': {
                            // 'background': '#fff',
                            // 'border': '1px solid',
                            // 'border-color': '#bbb3b9 #c7c1c6 #c7c1c6',
                            // 'box-sizing': 'border-box',
                            // 'font-family': 'serif',
                            // 'font-size': '16px',
                            // 'line-height': '1',
                            // 'margin': '0 .5em 0 0',
                            // 'max-width': '100%',
                            // 'outline': '0',
                            // 'padding': '0.5278em',
                            // 'vertical-align': 'baseline',
                            // 'width': '100%'
                        }
                    },
                    // Callback when a token is received from the service
                    onTokenSuccess: function (resp) {
                        var data = JSON.stringify(resp);
                        var url
                            = 'https://api.qrserver.com/v1/create-qr-code/?data='
                            + encodeURIComponent(data)
                            + '&size=320x320';
                        var el = document.createElement('img');
                        el.src = url;
                        var target = document.getElementById('result_qr');
                        target.style.display = 'block';
                        target.appendChild(el);
                    },
                    // Callback when an error is received from the service
                    onTokenError: function (resp) {
                        alert('There was an error: ' + resp.error.message);
                    },
                    // Callback when an event is fired within an iFrame
                    onEvent: function (ev) {
                        console.log(ev);
                    }
                });
            }

            function isCanvasSupported() {
                var elem = document.createElement('canvas');
                return !!(elem.getContext && elem.getContext('2d'));
            }

            window.load = function load() {
                if (isCanvasSupported() && window.File && window.FileReader) {
                    initCanvas(800, 600);
                    qrcode.callback = read;
                }
            };
        } (window, window.document));
    </script>
</head>

<body>
    <div>
        <img src="heartlandlogo.png">
    </div>
    <div>
        Need a QR code to scan?
        <a href="merchant.html" target="_blank">Visit the merchant</a>
        <br>
        <br>
    </div>
    <div>
        <label>
            Scan or Select Image
            <input type="file" onchange="handleFiles(this.files)" />
        </label>
    </div>
    <div id="result"></div>
    <div id="payment_form" style="display:none;">
        <dt><label for="iframesCardNumber">Card Number:</label></dt>
        <dd><div id="iframesCardNumber"></div></dd>
        <dt><label for="iframesCardExpiration">Card Expiration:</label></dt>
        <dd><div id="iframesCardExpiration"></div></dd>
        <dt><label for="iframesCardCvv">Card CVV:</label></dt>
        <dd><div id="iframesCardCvv"></div></dd>
        <br />
        <div id="iframesSubmit"></div>
    </div>
    <div id="result_qr" style="display:none;">
        Optional! <br><br>
        Show this QR code to the cashier:
    </div>
    <canvas id="qr-canvas" width="800" height="600"></canvas>
    <script type="text/javascript">load();</script>
</body>
</html>
